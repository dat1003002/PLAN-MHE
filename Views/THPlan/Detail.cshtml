@model PLANMHE.Models.Plan
@{
    ViewData["Title"] = "Chi Tiết Kế Hoạch";
    ViewData["CurrentPage"] = "/THPlan/Detail";
}
<div class="main-box">
    <div class="header-section">
        <div class="left-icon"><i class="ace-icon fa fa-star orange"></i></div>
        <div class="page-title">Thực Hiện Kế Hoạch Sản Xuất</div>
        <div class="right-settings"><i class="fa fa-regular fa-gear"></i></div>
    </div>
</div>
<div class="outer-wrapper">
    <div class="tabs">
        <button class="active">Thực Hiện kế hoạch</button>
    </div>
    <div class="tab-pane">
        <div class="main-section" style="background-color: #d9edf7; color:#31708f; border-color: #bce8f1;">
            <ul style="display:flex; align-items: center;">
                <li class="fa fa-hand-o-right" style="display:flex; color: #31708f; font-weight: 600;">
                    <p style="font-size: 15px;font-family: ui-monospace; margin:1px; padding-right: 10px;">
                        Xác nhận để hoàn thành kế hoạch
                    </p>
                </li>
                <li>
                    <button type="button" id="confirmPlanBtn" class="import"
                            style="background:#428BCA; color: white; border-radius: 3px; border: 1px solid #2E6589; border-bottom-width: 4px; padding: 2px 7px; font-size: 12px; font-family: segoeui;">Xác Nhận
                    </button>
                </li>
            </ul>
        </div>
        <div id="tableContainer" class="table-container">
            <table id="excelTable" class="table excel-table" style="display: none;">
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function () {
    let tableData = @Html.Raw(ViewBag.TableData ?? "[]");
    let colWidths = @Html.Raw(ViewBag.ColWidths ?? "[]");
    let rowHeights = @Html.Raw(ViewBag.RowHeights ?? "[]");
    let formats = @Html.Raw(ViewBag.Formats ?? "[]");
    let mergedCells = @Html.Raw(ViewBag.MergedCells ?? "[]");
    let totalColumnIndex = @ViewBag.TotalColumnIndex;
    let validColumnIndices = [...new Set(@Html.Raw(ViewBag.ValidColumnIndices ?? "[]"))];
    let lockedCells = @Html.Raw(ViewBag.LockedCells ?? "[]");
    let selectedCell = null;

    if (tableData.length > 0) {
        renderTable(tableData, formats, mergedCells, rowHeights, colWidths, totalColumnIndex, validColumnIndices, lockedCells);
    }

    function renderTable(data, formats, mergedCells, rowHeights, colWidths, totalColumnIndex, validColumnIndices, lockedCells) {
        const $table = $('#excelTable');
        const $tbody = $table.find('tbody').empty();

        // Tiền xử lý kích thước cột và hàng
        const pixelColWidths = colWidths.map(width => Math.max(Math.round(width || 60), 60));
        const pixelRowHeights = rowHeights.map(height => Math.max(Math.round(height || 30), 30));
        const skipCells = {};

        // Sử dụng DocumentFragment để tối ưu DOM
        const fragment = document.createDocumentFragment();

        data.forEach((rowData, rowIndex) => {
            const rowHeightPx = pixelRowHeights[rowIndex] || 30;
            const $tr = $('<tr>').css({
                'height': rowHeightPx + 'px',
                'min-height': rowHeightPx + 'px',
                'max-height': rowHeightPx + 'px'
            });

            rowData.forEach((cellData, colIndex) => {
                const cellKey = `${rowIndex}-${colIndex}`;
                if (skipCells[cellKey]) return;

                const $td = $('<td>').text(cellData || '').css({
                    'width': pixelColWidths[colIndex] + 'px',
                    'min-width': pixelColWidths[colIndex] + 'px',
                    'max-width': pixelColWidths[colIndex] + 'px',
                    'height': rowHeightPx + 'px',
                    'min-height': rowHeightPx + 'px',
                    'max-height': rowHeightPx + 'px',
                    'box-sizing': 'border-box',
                    'overflow': 'visible'
                });

                let css = formats[rowIndex][`col${colIndex + 1}`] || `background-color: #${colIndex === totalColumnIndex ? 'f0f0f0' : 'ffffff'}; color: #000000; font-size: 14px; font-weight: normal; text-align: ${colIndex === totalColumnIndex ? 'center' : 'left'}; font-family: Segoe UI`;
                let isMerged = false;
                let hasRowSpan = false;

                mergedCells.forEach(merge => {
                    if (merge.startRow === rowIndex + 1 && merge.startCol === colIndex + 1) {
                        isMerged = true;
                        if (merge.rowSpan > 1) hasRowSpan = true;
                    }
                });

                if (isMerged) {
                    css = css.replace(/text-align:\s*[^;]+;/, 'text-align: center;');
                    if (!css.includes('text-align')) css += ';text-align: center';
                    if (hasRowSpan) {
                        css = css.replace(/vertical-align:\s*[^;]+;/, 'vertical-align: middle;');
                        if (!css.includes('vertical-align')) css += ';vertical-align: middle';
                    }
                }

                if (colIndex === totalColumnIndex) {
                    css += ';background-color: #f0f0f0;cursor: not-allowed;';
                    $td.addClass('disabled-cell');
                }

                const isLocked = lockedCells.some(cell => cell.row === rowIndex + 1 && cell.col === colIndex + 1);
                if (isLocked) {
                    css += ';cursor: not-allowed;';
                    $td.addClass('disabled-cell');
                }

                $td.css(css.split(';').reduce((obj, style) => {
                    const [key, value] = style.split(':').map(s => s.trim());
                    if (key && value) obj[key] = value;
                    return obj;
                }, {}));

                $td.attr('style', css);
                $td.data('row', rowIndex).data('col', colIndex);

                mergedCells.forEach(merge => {
                    if (merge.startRow === rowIndex + 1 && merge.startCol === colIndex + 1) {
                        if (merge.rowSpan > 1) $td.attr('rowspan', merge.rowSpan);
                        if (merge.colSpan > 1) $td.attr('colspan', merge.colSpan);
                        let mergedWidth = 0;
                        for (let c = 0; c < merge.colSpan; c++) {
                            mergedWidth += pixelColWidths[colIndex + c] || 60;
                        }
                        $td.css({
                            'width': Math.round(mergedWidth) + 'px',
                            'min-width': Math.round(mergedWidth) + 'px',
                            'max-width': Math.round(mergedWidth) + 'px',
                            'height': (rowHeightPx * merge.rowSpan) + 'px',
                            'min-height': (rowHeightPx * merge.rowSpan) + 'px',
                            'max-height': (rowHeightPx * merge.rowSpan) + 'px'
                        });
                        for (let r = 0; r < merge.rowSpan; r++) {
                            for (let c = 0; c < merge.colSpan; c++) {
                                if (r === 0 && c === 0) continue;
                                skipCells[`${rowIndex + r}-${colIndex + c}`] = true;
                            }
                        }
                    }
                });

                if (colIndex !== totalColumnIndex && !isLocked) {
                    $td.on('click', function (e) {
                        const $this = $(this);
                        if ($this.find('input').length > 0) return;
                        if (selectedCell) {
                            selectedCell.element.removeClass('selected-cell');
                            selectedCell.element.text(selectedCell.newValue || selectedCell.element.text());
                        }
                        selectedCell = { row: rowIndex, col: colIndex, element: $this, newValue: $this.text() };
                        $this.addClass('selected-cell');
                        const currentText = $this.text() || '';
                        const currentBgColor = $this.css('background-color') || '#ffffff';
                        const cellPadding = parseFloat($this.css('padding') || 5);
                        const isMerged = $this.attr('rowspan') || $this.attr('colspan');
                        const hasRowSpan = $this.attr('rowspan') > 1;
                        const $input = $('<input>').attr('type', 'text').val(currentText).css({
                            'width': '100%',
                            'height': '100%',
                            'box-sizing': 'border-box',
                            'padding': cellPadding + 'px',
                            'font-size': $this.css('font-size'),
                            'font-family': $this.css('font-family'),
                            'font-weight': $this.css('font-weight'),
                            'text-align': isMerged ? 'center' : $this.css('text-align'),
                            'color': '#000000 !important',
                            'background-color': currentBgColor,
                            'border': '1px solid #ccc',
                            'margin': 0,
                            'display': 'block',
                            'outline': 'none',
                            'white-space': 'normal',
                            'word-wrap': 'break-word'
                        });
                        $this.empty().append($input);
                        $input.focus();
                        $input.on('input', function () {
                            selectedCell.newValue = $(this).val() ? $(this).val().trim() : '';
                        });
                        $input.on('blur', function () {
                            const newValue = $(this).val() ? $(this).val().trim() : '';
                            if (newValue !== currentText) {
                                updateCell(rowIndex, colIndex, newValue, totalColumnIndex, validColumnIndices);
                            }
                            $this.text(newValue || currentText);
                            $this.css({
                                'background-color': currentBgColor,
                                'color': '#000000',
                                'text-align': isMerged ? 'center' : $this.css('text-align'),
                                'vertical-align': hasRowSpan ? 'middle' : $this.css('vertical-align'),
                                'overflow': 'visible'
                            });
                            $input.remove();
                            $this.addClass('selected-cell');
                        });
                        $input.on('keypress', function (e) {
                            if (e.which === 13) {
                                $input.blur();
                            }
                        });
                    });
                }
                $tr.append($td);
            });
            fragment.appendChild($tr[0]);
        });

        $tbody.append(fragment);
        $table.css({
            'table-layout': 'fixed',
            'width': 'auto',
            'border-collapse': 'collapse'
        }).show();
    }

    function updateTotalCell(row, totalColumnIndex, validColumnIndices, formats, rowHeights, colWidths) {
        if (totalColumnIndex === -1 || !validColumnIndices.length) return;
        let sum = 0;
        validColumnIndices.forEach(validCol => {
            const cellValue = tableData[row][validCol] || '';
            const numValue = parseFloat(cellValue.replace(',', '.'));
            if (!isNaN(numValue)) sum += numValue;
        });
        tableData[row][totalColumnIndex] = Math.floor(sum) === sum ? sum.toString() : sum.toFixed(2);
        const $totalCell = $('#excelTable tbody tr').eq(row).find('td').eq(totalColumnIndex + 1);
        if ($totalCell.length) $totalCell.text(tableData[row][totalColumnIndex]);
        const planId = @Model.Id;
        const totalCell = {
            PlanId: planId,
            RowId: row + 1,
            ColumnId: totalColumnIndex + 1,
            Name: tableData[row][totalColumnIndex],
            BackgroundColor: 'f0f0f0',
            FontColor: '000000',
            FontSize: formats[row][`col${totalColumnIndex + 1}`]?.match(/font-size:\s*[^;]+/)?.[0]?.replace('font-size: ', '') || '14px',
            FontWeight: formats[row][`col${totalColumnIndex + 1}`]?.match(/font-weight:\s*[^;]+/)?.[0]?.replace('font-weight: ', '') || 'normal',
            TextAlign: 'center',
            FontFamily: 'Segoe UI',
            Rowspan: 1,
            Colspan: 1,
            RowHeight: rowHeights[row] || 30,
            ColWidth: colWidths[totalColumnIndex] || 60,
            InputSettings: '',
            IsHidden: false,
            IsFileUpload: false,
            IsDeleted: false,
            IsLocked: true
        };
        $.ajax({
            url: '/THPlan/UpdateCell',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(totalCell),
            success: function (response) {
                if (!response.success) return;
            },
            error: function () {}
        });
    }

    function updateCell(row, col, value, totalColumnIndex, validColumnIndices) {
        if (col === totalColumnIndex) return;
        const safeValue = value === null || value === undefined || value.trim() === '' ? '' : value.trim();
        tableData[row][col] = safeValue;
        const planId = @Model.Id;
        const mergeInfo = mergedCells.find(merge => merge.startRow === row + 1 && merge.startCol === col + 1);
        const planCell = {
            PlanId: planId,
            RowId: row + 1,
            ColumnId: col + 1,
            Name: safeValue,
            BackgroundColor: formats[row][`col${col + 1}`]?.match(/background-color:\s*#[0-9a-fA-F]+/)?.[0]?.replace('background-color: #', '') || 'ffffff',
            FontColor: '000000',
            FontSize: formats[row][`col${col + 1}`]?.match(/font-size:\s*[^;]+/)?.[0]?.replace('font-size: ', '') || '14px',
            FontWeight: formats[row][`col${col + 1}`]?.match(/font-weight:\s*[^;]+/)?.[0]?.replace('font-weight: ', '') || 'normal',
            TextAlign: formats[row][`col${col + 1}`]?.match(/text-align:\s*[^;]+/)?.[0]?.replace('text-align: ', '') || (mergeInfo ? 'center' : 'left'),
            FontFamily: formats[row][`col${col + 1}`]?.match(/font-family:\s*[^;]+/)?.[0]?.replace('font-family: ', '') || 'Segoe UI',
            Rowspan: mergeInfo ? mergeInfo.rowSpan : 1,
            Colspan: mergeInfo ? mergeInfo.colSpan : 1,
            RowHeight: rowHeights[row] || 30,
            ColWidth: colWidths[col] || 60,
            InputSettings: '',
            IsHidden: false,
            IsFileUpload: false,
            IsDeleted: false,
            IsLocked: lockedCells.some(cell => cell.row === row + 1 && cell.col === col + 1)
        };
        $.ajax({
            url: '/THPlan/UpdateCell',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(planCell),
            success: function (response) {
                if (!response.success) return;
                if (totalColumnIndex !== -1 && validColumnIndices.includes(col)) {
                    updateTotalCell(row, totalColumnIndex, validColumnIndices, formats, rowHeights, colWidths);
                }
                tableData = response.data.tableData;
                formats = response.data.formats;
                mergedCells = response.data.mergedCells;
                rowHeights = response.data.rowHeights;
                colWidths = response.data.colWidths;
                totalColumnIndex = response.data.totalColumnIndex;
                validColumnIndices = response.data.validColumnIndices;
                lockedCells = response.data.lockedCells;
                renderTable(tableData, formats, mergedCells, rowHeights, colWidths, totalColumnIndex, validColumnIndices, lockedCells);
            },
            error: function () {}
        });
    }

    $('#confirmPlanBtn').on('click', async function() {
        const $btn = $(this);
        const originalText = $btn.html();
        $btn.prop('disabled', true).html('⏳ Đang xác nhận...');
        try {
            const planId = @Model.Id;
            const response = await $.ajax({
                url: '/THPlan/ConfirmPlan',
                type: 'POST',
                data: { planId: planId }
            });
            if (response.success) {
                $btn.fadeOut(500, function() {
                    $(this).closest('li').html('<span style="color:#28a745; font-weight:bold; font-size:14px;">✅ HOÀN THÀNH</span>');
                });
                $('#excelTable td').off('click').addClass('disabled-cell').css('cursor', 'not-allowed');
                $('.main-section').html(`
                    <ul style="display:flex; align-items: center;">
                        <li style="color: #28a745; font-weight: 600;">
                            <p style="font-size: 15px; color: #28a745; padding-right: 10px;">
                                KẾ HOẠCH ĐÃ HOÀN THÀNH ✅
                            </p>
                        </li>
                    </ul>
                `);
                tableData = response.data.tableData;
                formats = response.data.formats;
                mergedCells = response.data.mergedCells;
                rowHeights = response.data.rowHeights;
                colWidths = response.data.colWidths;
                totalColumnIndex = response.data.totalColumnIndex;
                validColumnIndices = response.data.validColumnIndices;
                lockedCells = response.data.lockedCells;
                renderTable(tableData, formats, mergedCells, rowHeights, colWidths, totalColumnIndex, validColumnIndices, lockedCells);
            } else {
                alert(response.message);
            }
        } catch (error) {
            alert('Không thể xác nhận: ' + (error.responseJSON?.message || 'Lỗi không xác định'));
        } finally {
            $btn.prop('disabled', false).html(originalText);
        }
    });
});
</script>
