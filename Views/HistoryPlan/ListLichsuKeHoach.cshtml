@model IEnumerable<PLANMHE.Models.Plan>

<div class="main-box">
	<div class="header-section">
		<div class="left-icon"><i class="ace-icon fa fa-star orange"></i></div>
		<div class="page-title">Lịch Sử Kế Hoạch</div>
		<div class="right-settings"><i class="fa fa-regular fa-gear"></i></div>
	</div>
</div>

<div class="main-container">
	<div class="search-area">
		<input type="text" id="searchUsername" placeholder="Tìm tên kế hoạch hoặc người thực hiện" />
	</div>
	<div class="options">
		<label><input type="radio" name="status" value="all" checked> Tất cả</label>
		<label class="status-using"><input type="radio" name="status" value="active"> Đang thực hiện</label>
		<label class="status-deleted"><input type="radio" name="status" value="completed"> Đã Hoàn Thành</label>
	</div>
</div>

<table id="planTable" class="table table-bordered table-hover" style="width: 100%; table-layout: fixed;">
	<thead class="thead-light">
		<tr class="mvc-grid-headers">
			<th style="width: 5%; text-align: center;">STT</th>
			<th style="width: 20%;">Tên Kế Hoạch</th>
			<th style="width: 15%; text-align: center;">Ngày Bắt Đầu</th>
			<th style="width: 15%; text-align: center;">Ngày Kết Thúc</th>
			<th style="width: 15%; text-align: center;">Trạng thái</th>
			<th style="width: 20%;">Người Thực Hiện</th>
			<th style="width: 10%;">Hành Động</th>
		</tr>
	</thead>
	<tbody>
		@if (Model != null && Model.Any())
		{
			int stt = (ViewBag.CurrentPage - 1) * 10 + 1;
			foreach (var plan in Model)
			{
				// LẤY DANH SÁCH NGƯỜI THỰC HIỆN
				var assignedUsers = plan.UserPlans?
				.Where(up => up.User != null)
				.Select(up => up.User.FullName.Trim())
				.Distinct()
				.ToList() ?? new List<string>();

				var userDisplay = assignedUsers.Any()
				? string.Join(", ", assignedUsers)
				: "<i style='color: #999; font-weight: normal;'>Chưa phân công</i>";

				var userSearchText = string.Join(",", assignedUsers).ToLower();

				<tr class="data-row"
					data-status="@plan.Status.ToLower()"
					data-name="@plan.Name.ToLower()"
					data-users="@userSearchText">
					<td style="text-align: center; font-weight: 500;">@stt</td>
					<td style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="@plan.Name">
						<a href="@Url.Action("Detail", "HistoryPlan", new { id = plan.Id })"
						   style="color: #007bff; text-decoration: none; display: block;">
							@plan.Name
						</a>
					</td>
					<td style="text-align: center;">@plan.StartDate.ToString("dd/MM/yyyy")</td>
					<td style="text-align: center;">@plan.EndDate.ToString("dd/MM/yyyy")</td>
					<td style="text-align: center;">
						@if (plan.Status == "Active")
						{
							<button class="status-button" style="background-color: #28a745; color: white; border: none; padding: 0px 8px; border-radius: 4px; font-size: 11px; cursor: default;">
								Đang thực hiện
							</button>
						}
						else if (plan.Status == "Completed")
						{
							<button class="status-button" style="background-color: #dc3545; color: white; border: none; padding: 0px 8px; border-radius: 4px; font-size: 11px; cursor: default;">
								Đã Hoàn Thành
							</button>
						}
						else
						{
							<span>@plan.Status</span>
						}
					</td>
					<td style="font-size: 14px; line-height: 1.5; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"
						title="@(assignedUsers.Any() ? string.Join(", ", assignedUsers) : "Chưa phân công")">
						@Html.Raw(userDisplay)
					</td>
					<td class="action-center">
						<a href="@Url.Action("Detail", "HistoryPlan", new { id = plan.Id })"
						   class="action-eye-btn"
						   title="Xem chi tiết kế hoạch">
							<i class="ace-icon fa fa-eye"></i>
						</a>
					</td>
				</tr>
				stt++;
			}
		}
		else
		{
			<tr>
				<td colspan="6" style="text-align: center; color: #999; padding: 20px;">
					<i class="fa fa-inbox"></i> Không có kế hoạch nào.
				</td>
			</tr>
		}
	</tbody>
</table>

<!-- PHÂN TRANG -->
<div style="display: flex; justify-content: center; margin-top: 20px;">
	<nav aria-label="Page navigation">
		<ul class="pagination">
			<li class="page-item @((ViewBag.CurrentPage == 1) ? "disabled" : "")">
				<a class="page-link" href="@Url.Action("ListLichsuKeHoach", new { pageNumber = ViewBag.CurrentPage - 1 })">&laquo;</a>
			</li>
			@for (int i = 1; i <= ViewBag.TotalPages; i++)
			{
				<li class="page-item @(i == ViewBag.CurrentPage ? "active" : "")">
					<a class="page-link" href="@Url.Action("ListLichsuKeHoach", new { pageNumber = i })">@i</a>
				</li>
			}
			<li class="page-item @((ViewBag.CurrentPage == ViewBag.TotalPages) ? "disabled" : "")">
				<a class="page-link" href="@Url.Action("ListLichsuKeHoach", new { pageNumber = ViewBag.CurrentPage + 1 })">&raquo;</a>
			</li>
		</ul>
	</nav>
</div>

<!-- SCRIPT TÌM KIẾM + LỌC -->
<script>
	document.addEventListener('DOMContentLoaded', function () {
		const radioButtons = document.querySelectorAll('input[name="status"]');
		const searchInput = document.querySelector('#searchUsername');
		const tableRows = document.querySelectorAll('#planTable .data-row');

		function filterPlans() {
			const selectedStatus = document.querySelector('input[name="status"]:checked').value;
			const searchQuery = searchInput.value.trim().toLowerCase();

			tableRows.forEach(row => {
				const rowStatus = row.getAttribute('data-status') || '';
				const rowName = row.getAttribute('data-name') || '';
				const rowUsers = row.getAttribute('data-users') || '';

				const matchesStatus = selectedStatus === 'all' || rowStatus === selectedStatus;
				const matchesSearch = searchQuery === '' ||
					rowName.includes(searchQuery) ||
					rowUsers.includes(searchQuery);

				row.style.display = (matchesStatus && matchesSearch) ? '' : 'none';
			});
		}

		radioButtons.forEach(radio => radio.addEventListener('change', filterPlans));
		searchInput.addEventListener('input', filterPlans);
		filterPlans();
	});
</script>
